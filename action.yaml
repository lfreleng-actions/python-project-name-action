---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# python-project-name-action
name: "ðŸ Python Project/Package Names"
description: "Extracts Python project name and derives the package name"

inputs:
  # Optional
  path_prefix:
    description: "Directory location containing project code"
    required: false

outputs:
  # Mandatory
  python_project_file:
    # Supports both pyproject.toml and setup.py
    description: "File used to extract/parse project metadata"
    value: ${{ steps.capture.outputs.python_project_file }}
  python_project_name:
    description: "Name of the Python project from pyproject.toml/setup.py"
    value: ${{ steps.capture.outputs.python_project_name }}
  python_package_name:
    # Note: dashes in the name are substituted with underscores
    description: "The name of the Python package"
    value: ${{ steps.capture.outputs.python_package_name }}
  source:
    description: >-
      Source file where project details were found
      (pyproject.toml or setup.py)
    value: ${{ steps.capture.outputs.source }}

runs:
  using: "composite"
  steps:
    - name: "Setup action/environment"
      shell: bash
      run: |
        # Setup action/environment

        # Handle path_prefix input consistently and when absent
        path_prefix="${{ inputs.path_prefix }}"
        if [ -z "$path_prefix" ]; then
          # Set current directory as path prefix
          path_prefix="."
        else
          # Strip any trailing slash in provided path
          path_prefix="${path_prefix%/}"
        fi
        # Verify is a valid directory path
        if [ ! -d "$path_prefix" ]; then
          echo "Error: invalid path/prefix to project directory âŒ"; exit 1
        fi
        echo "path_prefix=$path_prefix" >> "$GITHUB_ENV"

    # Check for pyproject.toml first (preferred)
    # yamllint disable-line rule:line-length
    - uses: lfreleng-actions/path-check-action@9606e61c870025bc956e63156d1d55c5df54426c # v0.2.0
      id: pyproject-toml
      with:
        path: "${{ env.path_prefix }}/pyproject.toml"

    - name: "Get project name from pyproject.toml"
      id: pyproject-name
      if: steps.pyproject-toml.outputs.type == 'file'
      # yamllint disable-line rule:line-length
      uses: lfreleng-actions/file-grep-regex-action@ba13750798b15e6acf23f3342a280ffc8148b950 # v0.1.4
      with:
        flags: "-oP -m1"
        regex: '(?<=^name = ")([^"]*)'
        filename: "${{ env.path_prefix }}/pyproject.toml"

    # Fall back to setup.py if pyproject.toml doesn't exist
    # yamllint disable-line rule:line-length
    - uses: lfreleng-actions/path-check-action@9606e61c870025bc956e63156d1d55c5df54426c # v0.2.0
      id: setup-py
      if: steps.pyproject-toml.outputs.type != 'file'
      with:
        path: "${{ env.path_prefix }}/setup.py"

    - name: "Get project name from setup.py"
      id: setup-name
      if: >-
        steps.pyproject-toml.outputs.type != 'file' &&
        steps.setup-py.outputs.type == 'file'
      # yamllint disable-line rule:line-length
      uses: lfreleng-actions/file-grep-regex-action@ba13750798b15e6acf23f3342a280ffc8148b950 # v0.1.4
      with:
        flags: "-oP -m1"
        regex: '(?<=name=")([^"]*)'
        filename: "${{ env.path_prefix }}/setup.py"

    - name: "Capture Python project metadata"
      id: capture
      shell: bash
      # yamllint disable rule:line-length
      run: |
        # Capture Python project metadata

        # pyproject.toml is preferred source
        if [ "${{ steps.pyproject-toml.outputs.type }}" = 'file' ]; then
          PYTHON_PROJECT_NAME="${{ steps.pyproject-name.outputs.extracted_string }}"
          PYTHON_PROJECT_FILE="pyproject.toml"
          SOURCE="pyproject.toml"
          echo "Using project name from: pyproject.toml âœ…"

        # Fall back to setup.py if pyproject.toml not found
        elif [ "${{ steps.setup-py.outputs.type }}" = 'file' ]; then
          PYTHON_PROJECT_NAME="${{ steps.setup-name.outputs.extracted_string }}"
          PYTHON_PROJECT_FILE="setup.py"
          SOURCE="setup.py"
          echo "Using project name from: setup.py âš ï¸"
        else
          echo "Error: Neither pyproject.toml nor setup.py found âŒ"
          exit 1
        fi

        if [ -z "$PYTHON_PROJECT_NAME" ]; then
          echo "Python project name extraction failed âŒ"
          exit 1
        fi
        echo "Python project name: $PYTHON_PROJECT_NAME ðŸ’¬"

        # Replace all dashes in the name with underscores
        PYTHON_PACKAGE_NAME=$(echo "$PYTHON_PROJECT_NAME" | tr '-' '_')
        echo "Python package name: $PYTHON_PACKAGE_NAME"

        # Make available to the GitHub environment
        echo "python_project_name=$PYTHON_PROJECT_NAME" >> "$GITHUB_ENV"
        echo "python_project_name=$PYTHON_PROJECT_NAME" >> "$GITHUB_OUTPUT"
        echo "python_package_name=$PYTHON_PACKAGE_NAME" >> "$GITHUB_ENV"
        echo "python_package_name=$PYTHON_PACKAGE_NAME" >> "$GITHUB_OUTPUT"
        echo "python_project_file=$PYTHON_PROJECT_FILE" >> "$GITHUB_ENV"
        echo "python_project_file=$PYTHON_PROJECT_FILE" >> "$GITHUB_OUTPUT"
        echo "source=$SOURCE" >> "$GITHUB_ENV"
        echo "source=$SOURCE" >> "$GITHUB_OUTPUT"
